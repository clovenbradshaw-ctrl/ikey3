<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>iKey - Your data. Your key.</title>
    <meta name="description" content="Secure personal information with zero-knowledge encryption. Only your QR code can unlock your data.">

    <style>
        /* Softr embedding fixes */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #4F46E5;
            --danger: #EF4444;
            --success: #10B981;
            --warning: #F59E0B;
            --surface: #FFFFFF;
            --surface-alt: #F9FAFB;
            --text: #111827;
            --text-secondary: #6B7280;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            overflow-x: hidden !important;
            width: 100% !important;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--surface-alt);
            min-height: 100vh !important;
            display: flex !important;
            flex-direction: column;
            align-items: center !important;
            justify-content: flex-start !important;
            padding-top: 80px !important;
        }

        #healthRecordsTab,
        #clientCreatorTab,
        #qrTab,
        #text911Tab {
            width: 100%;
        }

        .container {
            width: 100% !important;
            max-width: none;
            margin: 0 !important;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: visible;
            animation: slideIn 0.3s ease;
        }

        @media (max-width: 640px) {
            .container {
                max-width: 100%;
                border-radius: 0 !important;
                margin: 0 !important;
                padding-bottom: 80px;
            }

            body {
                background: white !important;
                align-items: flex-start !important;
            }

            .top-bar {
                display: flex;
                justify-content: space-between;
                grid-template-columns: none;
                flex-wrap: wrap;
                height: auto;
                padding: 4px 10px;
            }
            
            .logo-text-full {
                display: none;
            }

            .logo-text-short {
                display: inline;
            }

            .controls {
                flex-wrap: wrap;
                gap: 6px;
            }

            .dashboard-btn,
            .health-records-btn {
                display: none !important;
            }

            .dashboard-header {
                flex-direction: row;
                align-items: center;
            }

            .progress-ring,
            .progress-ring svg {
                width: 60px;
                height: 60px;
            }

            .section-cards {
                display: grid;
                grid-template-columns: 1fr;
            }

            .section-card {
                margin: 8px;
                padding: 12px;
                position: relative;
            }

            .action-buttons {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e5e7eb;
                padding: 12px;
                display: flex;
                gap: 8px;
                z-index: 100;
            }

            .action-buttons .btn {
                flex: 1;
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .content {
            padding: 20px;
        }

        /* Info Display Mode */
        .info-card {
            animation: fadeIn 0.5s ease;
        }

        .info-header {
            background: #ff4757;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .info-header h2 {
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .info-item:last-child {
            margin-bottom: 0;
        }

        .info-icon {
            font-size: 1.25rem;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 2px;
        }

        .info-value {
            font-size: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }

        .phone-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            padding: 8px 12px;
            background: #e8f0fe;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .phone-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .private-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .private-section h3 {
            color: #856404;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .password-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 8px;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }

        .hint {
            font-size: 0.75rem;
            color: #856404;
            margin-bottom: 10px;
            font-style: italic;
        }

        /* Creation Form Mode */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .section-title {
            font-size: 1rem;
            color: #2c3e50;
            margin: 25px 0 15px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-weight: 600;
        }

        .section-title:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .section-fieldset {
            border: none;
            padding: 0;
            margin: 0 0 20px 0;
        }

        .section-fieldset legend {
            width: 100%;
            font-size: 1rem;
            color: #2c3e50;
            margin: 25px 0 15px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-weight: 600;
        }

        .section-fieldset:first-of-type legend {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .section-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            margin-left: 8px;
        }

        .section-status.complete {
            background: #d1fae5;
            color: #065f46;
        }

        .section-status.incomplete {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            margin-top: 10px;
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        /* QR Display */
        .qr-display {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-top: 20px;
        }

        #qrcode {
            display: inline-block;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        /* Top navigation */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            padding: 4px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            justify-self: start;
        }

        .logo {
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .logo-text-short {
            display: none;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            justify-self: end;
        }

        .size-controls {
            display: flex;
            gap: 4px;
        }

        .lang-select {
            position: relative;
        }

        .lang-button {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.875rem;
            direction: ltr;
        }

        .size-toggle {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .lang-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            max-height: 300px;
            overflow-y: auto;
            min-width: 160px;
            z-index: 1000;
            direction: ltr;
            text-align: left;
        }

        .lang-option {
            padding: 8px 12px;
            cursor: pointer;
            white-space: nowrap;
        }

        .lang-option:hover,
        .lang-option.active {
            background: #f0f0f0;
        }

        .login-btn,
        .app-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .dashboard-btn, 
        .logout-btn,
        .health-records-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        /* Help Section */
        .help-link {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .help-link a {
            color: #667eea;
            text-decoration: none;
            font-size: 0.875rem;
        }

        .help-content {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            font-size: 0.875rem;
            line-height: 1.6;
            display: none;
        }

        .help-content.active {
            display: block;
        }

        /* Loading State */
        .loading-screen {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Messages */
        .status-message {
            padding: 10px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-size: 0.875rem;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Dashboard styles */
        .dashboard-container {
            padding: 20px;
        }

        .dashboard-header {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-ring {
            position: relative;
            width: 120px;
            height: 120px;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .progress-text .percent {
            font-size: 24px;
            font-weight: bold;
        }

        .section-cards {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 640px) {
            .section-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .section-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .section-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            position: relative;
        }

        .section-card.complete {
            opacity: 0.7;
        }

        .edit-section-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: transparent;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .edit-section-btn:hover {
            text-decoration: underline;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .section-icon {
            font-size: 20px;
        }

        .mini-progress {
            flex: 1;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            position: relative;
        }

        .mini-progress .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
        }

        .field-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 0.875rem;
            border-bottom: 1px solid var(--surface-alt);
            min-height: 48px;
        }

        .field-row.missing {
            opacity: 0.6;
        }

        .add-button {
            color: var(--primary);
            cursor: pointer;
            font-weight: 500;
            min-width: 44px;
            min-height: 44px;
            padding: 12px 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .add-button:hover {
            text-decoration: underline;
        }

        .field-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .field-modal.active { 
            display: flex; 
        }

        .modal-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            position: relative;
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            z-index: 1;
            max-width: 600px;
            width: calc(100% - 40px);
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-content h3 {
            margin-bottom: 4px;
        }

        .modal-content input,
        .modal-content select,
        .modal-content textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.125rem;
        }

        .modal-content textarea {
            min-height: 160px;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.125rem;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.125rem;
        }

        .quick-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            background: #f0f0f0;
            cursor: pointer;
        }

        .action-btn.primary {
            background: #667eea;
            color: #fff;
        }

        .badge {
            background: #fff;
            color: #667eea;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-size: 0.75rem;
        }

        .security-status .level-excellent { color: #38a169; }
        .security-status .level-good { color: #48bb78; }
        .security-status .level-fair { color: #ed8936; }
        .security-status .level-basic { color: #e53e3e; }

        .privacy-notice {
            background: #e8f4f8;
            border: 2px solid #4a90e2;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .privacy-notice h3 {
            color: #2c5282;
            margin-bottom: 15px;
        }

        .privacy-notice ul {
            list-style: none;
            padding: 0;
        }

        .privacy-notice li {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
        }

        .privacy-notice li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #48bb78;
            font-weight: bold;
        }

        /* Blood type selector */
        .blood-type-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin: 12px 0;
        }

        .blood-type-btn {
            position: relative;
            min-height: 48px;
            min-width: 48px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            transition: all 0.2s;
        }

        .blood-type-btn:hover,
        .blood-type-btn:focus {
            border-color: #6366f1;
            background: #eef2ff;
        }

        .blood-type-btn.selected {
            background: #6366f1;
            color: white;
            border-color: #6366f1;
        }

        .blood-type-btn input {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .unknown-option {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: #f9fafb;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
        }

        /* PIN Pad Styles */
        .pin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, #0f0f1e 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .pin-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .pin-overlay::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        .pin-container {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            padding: 40px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 420px;
            position: relative;
        }

        .pin-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .lock-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 15px;
        }

        .lock-icon svg {
            width: 100%;
            height: 100%;
            fill: none;
            stroke: #6366f1;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .pin-title {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .pin-subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 14px;
            font-weight: 300;
        }

        .pin-display {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 35px;
            display: flex;
            justify-content: center;
            gap: 12px;
            min-height: 70px;
            align-items: center;
        }

        .pin-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pin-dot.filled {
            background: #6366f1;
            border-color: #6366f1;
            transform: scale(1.2);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
        }

        .pin-dot.error {
            animation: shake 0.5s;
            background: #ef4444;
            border-color: #ef4444;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .pin-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .pin-key {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 24px;
            font-weight: 300;
            height: 70px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .pin-key:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
        }

        .pin-key:active {
            transform: translateY(0);
            background: rgba(99, 102, 241, 0.2);
        }

        .pin-key.zero-key {
            grid-column: 2;
        }

        .pin-action-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .pin-action-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            color: rgba(255, 255, 255, 0.7);
            padding: 15px;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
        }

        .pin-action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }

        .pin-action-btn.delete {
            border-color: rgba(239, 68, 68, 0.3);
        }

        .pin-action-btn.delete:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }

        .pin-action-btn.cancel {
            border-color: rgba(156, 163, 175, 0.3);
        }

        .pin-error-message {
            color: #ef4444;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            min-height: 20px;
        }

        /* Emergency card */
        .emergency-card {
            margin: 16px;
            padding: 16px;
            background: #fff5f5;
            border: 2px dashed var(--danger);
            border-radius: 12px;
        }

        .emergency-card h3 {
            margin-bottom: 8px;
        }

        .access-911 {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .access-911:active {
            opacity: 0.9;
        }

        /* Dev Tools */
        .dev-trigger {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dev-trigger:hover {
            opacity: 1;
        }

        .dev-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            color: white;
            padding: 20px;
            transform: translateY(100%);
            transition: transform 0.3s;
            max-height: 50vh;
            overflow-y: auto;
        }

        .dev-panel.active {
            transform: translateY(0);
        }

        .dev-panel h3 {
            margin-bottom: 15px;
            color: white;
        }

        .dev-panel input,
        .dev-panel textarea {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .dev-panel button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .dev-output {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.75rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Field info */
        .field-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #555;
            margin-top: 4px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="logo-container">
            <div class="logo" onclick="showClientCreator()">
                🔑 <span class="logo-text-full">iKey</span><span class="logo-text-short">iKey</span>
            </div>
        </div>
        <div class="controls">
            <div class="size-controls">
                <button class="size-toggle" onclick="changeTextSize(-1)">🔍-</button>
                <button class="size-toggle" onclick="changeTextSize(1)">🔍+</button>
            </div>
            <div class="lang-select">
                <button class="lang-button" onclick="toggleLangDropdown()">
                    <span id="current-language">EN</span> ▼
                </button>
                <div class="lang-dropdown"></div>
            </div>
            <button class="dashboard-btn" onclick="showOwnerDashboard()">Dashboard</button>
            <button class="health-records-btn" onclick="showHealthRecordsTab()">EHR</button>
            <button class="app-btn" onclick="showQRTab()">App</button>
            <button class="login-btn" onclick="ownerLogin()">Owner Login</button>
            <button class="logout-btn" onclick="logoutOwner()">Logout</button>
        </div>
    </div>

    <div id="clientCreatorTab">
        <!-- This would normally load an iframe, but for testing we'll show a simple message -->
        <div class="container">
            <div class="header">
                <h1>Welcome to iKey</h1>
                <p>Create your secure emergency information QR code</p>
            </div>
            <div class="content">
                <button class="btn" onclick="showQRTab(); showCreationForm();">
                    Create New iKey
                </button>
            </div>
        </div>
    </div>

    <div id="qrTab" style="display:none;">
        <div class="container">
            <div id="main-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <div id="healthRecordsTab" style="display:none;">
        <div class="container">
            <div class="header">
                <h1>Electronic Health Records</h1>
            </div>
            <div class="content">
                <p>Health records vault feature coming soon.</p>
            </div>
        </div>
    </div>

    <div id="text911Tab" style="display:none;">
        <div class="container">
            <div class="header">
                <h1>📍 911 Emergency Location</h1>
                <p>Share your precise location for emergency services</p>
            </div>
            <div class="content">
                <div id="location-permission-prompt">
                    <div class="privacy-notice">
                        <h3>🔒 Your Privacy is Protected</h3>
                        <ul style="text-align: left; margin: 20px 0;">
                            <li>Location is ONLY used when you're on this screen</li>
                            <li>Nothing is saved online or stored anywhere</li>
                            <li>Location data stays on your device</li>
                            <li>Only shared if YOU choose to text 911</li>
                        </ul>
                    </div>
                    <button class="btn" onclick="requestLocationAndLoad911()">
                        <span>Enable Location for Emergency Use</span>
                    </button>
                </div>
                <div id="location-content" style="display:none;">
                    <p>Emergency location features enabled.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Dev Tools Panel -->
    <div class="dev-trigger" onclick="toggleDevTools()">🛠️</div>
    <div id="dev-panel" class="dev-panel">
        <h3>🛠️ Dev Tools</h3>
        <div style="margin-bottom: 15px;">
            <input type="text" id="dev-guid" placeholder="Enter GUID">
            <input type="text" id="dev-key" placeholder="Enter Key">
            <button onclick="devLoadQR()">Load QR</button>
            <button onclick="devTestArchive()">Test Archive Fetch</button>
        </div>
        <div style="margin-bottom: 15px;">
            <button onclick="devCreateTestQR()">Create Test QR</button>
            <button onclick="devShowRawData()">Show Raw Data</button>
            <button onclick="devClearStorage()">Clear All Data</button>
            <button onclick="toggleDevTools()">Close</button>
        </div>
        <div class="dev-output" id="dev-output"></div>
    </div>

    <!-- PIN Pad Overlay -->
    <div id="pin-overlay" class="pin-overlay">
        <div class="pin-container">
            <div class="pin-header">
                <div class="lock-icon">
                    <svg viewBox="0 0 24 24">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0110 0v4"/>
                    </svg>
                </div>
                <h1 class="pin-title">Enter Security PIN</h1>
                <p class="pin-subtitle">Please enter your 6-digit code</p>
            </div>
            
            <div class="pin-display" id="pinDisplay">
                <div class="pin-dot" id="dot1"></div>
                <div class="pin-dot" id="dot2"></div>
                <div class="pin-dot" id="dot3"></div>
                <div class="pin-dot" id="dot4"></div>
                <div class="pin-dot" id="dot5"></div>
                <div class="pin-dot" id="dot6"></div>
            </div>
            
            <div class="pin-keypad">
                <button class="pin-key" data-value="1">1</button>
                <button class="pin-key" data-value="2">2</button>
                <button class="pin-key" data-value="3">3</button>
                <button class="pin-key" data-value="4">4</button>
                <button class="pin-key" data-value="5">5</button>
                <button class="pin-key" data-value="6">6</button>
                <button class="pin-key" data-value="7">7</button>
                <button class="pin-key" data-value="8">8</button>
                <button class="pin-key" data-value="9">9</button>
                <div></div>
                <button class="pin-key zero-key" data-value="0">0</button>
                <div></div>
            </div>
            
            <div class="pin-action-row">
                <button class="pin-action-btn delete" id="clearBtn">Clear</button>
                <button class="pin-action-btn cancel" id="cancelBtn">Cancel</button>
            </div>
            
            <div class="pin-error-message" id="pinErrorMessage"></div>
        </div>
    </div>

    <!-- QR Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

    <script>
        // ============= CONFIGURATION =============
        const CONFIG = {
            VIEWER_URL: window.location.origin + window.location.pathname,
            WEBHOOK_URL: 'https://n8n.intelechia.com/webhook/d5e99c29-2cf1-44c1-b5b4-95a1ca048441',
            ARCHIVE_BASE: 'https://archive.org/download/zuboff/',
            BEACON_TEXT: 'SQR:1',
            // For testing, we'll use a mock archive service
            USE_MOCK_ARCHIVE: true
        };

        // ============= THREE LAYER ENCRYPTION =============
        class ThreeLayerEncryption {
            static generateQrKey() {
                const buf = self.crypto.getRandomValues(new Uint8Array(32));
                return this.arrayBufferToBase64(buf.buffer);
            }

            static arrayBufferToBase64(buffer) {
                return btoa(String.fromCharCode(...new Uint8Array(buffer)));
            }

            static base64ToArrayBuffer(str) {
                return Uint8Array.from(atob(str), c => c.charCodeAt(0)).buffer;
            }

            static async importKey(base64Key) {
                const raw = this.base64ToArrayBuffer(base64Key);
                return await self.crypto.subtle.importKey(
                    'raw',
                    raw,
                    { name: 'AES-GCM' },
                    false,
                    ['encrypt', 'decrypt']
                );
            }

            static async deriveKey(material, salt, iterations) {
                const enc = new TextEncoder();
                const keyMaterial = await self.crypto.subtle.importKey(
                    'raw',
                    enc.encode(material),
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );

                const key = await self.crypto.subtle.deriveKey(
                    {
                        name: 'PBKDF2',
                        salt,
                        iterations,
                        hash: 'SHA-256'
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );

                const raw = await self.crypto.subtle.exportKey('raw', key);
                return this.arrayBufferToBase64(raw);
            }

            static async derivePinKey(pin, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await self.crypto.subtle.importKey(
                    'raw',
                    enc.encode(pin),
                    'PBKDF2',
                    false,
                    ['deriveBits', 'deriveKey']
                );
                
                const key = await self.crypto.subtle.deriveKey(
                    { 
                        name: 'PBKDF2', 
                        salt, 
                        iterations: 100000, 
                        hash: 'SHA-256' 
                    },
                    keyMaterial,
                    { name: 'AES-GCM', length: 256 },
                    true,
                    ['encrypt', 'decrypt']
                );
                
                const raw = await self.crypto.subtle.exportKey('raw', key);
                return this.arrayBufferToBase64(raw);
            }

            static async sha256(text) {
                const data = new TextEncoder().encode(text);
                const hash = await self.crypto.subtle.digest('SHA-256', data);
                return this.arrayBufferToBase64(hash);
            }

            static async encrypt(obj, keyBase64) {
                const key = await this.importKey(keyBase64);
                const iv = self.crypto.getRandomValues(new Uint8Array(12));
                const data = new TextEncoder().encode(JSON.stringify(obj));
                const encrypted = await self.crypto.subtle.encrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    data
                );
                return {
                    iv: this.arrayBufferToBase64(iv.buffer),
                    data: this.arrayBufferToBase64(encrypted)
                };
            }

            static async decrypt(encObj, keyBase64) {
                const key = await this.importKey(keyBase64);
                const iv = new Uint8Array(this.base64ToArrayBuffer(encObj.iv));
                const data = this.base64ToArrayBuffer(encObj.data);
                const decrypted = await self.crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv },
                    key,
                    data
                );
                const decoded = new TextDecoder().decode(decrypted);
                return JSON.parse(decoded);
            }
        }

        // ============= STATE MANAGEMENT =============
        let currentGUID = null;
        let currentKey = null;
        let currentData = null;
        let currentBlob = null;
        let currentMode = null;
        let ownerPassword = null;
        let currentPIN = null;
        let pinUnlocked = false;
        let passwordUnlocked = false;
        let translations = {
            en: {
                emergencyInfo: "Emergency Information",
                name: "Name",
                bloodType: "Blood Type",
                allergies: "Allergies",
                medications: "Medications",
                emergencyContact: "Emergency Contact",
                createYourKey: "Create Your iKey",
                tagline: "Your data. Your key. Your control.",
                password: "Password",
                confirmPassword: "Confirm Password",
                createKey: "Create iKey",
                download: "Download",
                test: "Test"
            }
        };
        let currentLanguage = 'en';

        // Mock storage for testing
        const mockArchiveStorage = new Map();

        // PIN Pad functionality
        let pinEntry = '';
        let pinAttempts = 0;
        const maxPinAttempts = 3;

        function initPinPad() {
            const keys = document.querySelectorAll('.pin-key[data-value]');
            const clearBtn = document.getElementById('clearBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const dots = document.querySelectorAll('.pin-dot');

            function updatePinDisplay() {
                dots.forEach((dot, index) => {
                    if (index < pinEntry.length) {
                        dot.classList.add('filled');
                    } else {
                        dot.classList.remove('filled');
                    }
                    dot.classList.remove('error');
                });
            }

            function clearPin() {
                pinEntry = '';
                updatePinDisplay();
                document.getElementById('pinErrorMessage').textContent = '';
            }

            function submitPin() {
                if (pinEntry.length === 6) {
                    verifyPin(pinEntry);
                }
            }

            keys.forEach(key => {
                key.addEventListener('click', () => {
                    if (pinEntry.length < 6) {
                        pinEntry += key.getAttribute('data-value');
                        updatePinDisplay();
                        
                        if (pinEntry.length === 6) {
                            setTimeout(() => {
                                submitPin();
                            }, 300);
                        }
                    }
                });
            });

            clearBtn.addEventListener('click', clearPin);
            cancelBtn.addEventListener('click', () => {
                closePinPad();
                clearPin();
            });

            // Keyboard support
            document.addEventListener('keydown', (e) => {
                const overlay = document.getElementById('pin-overlay');
                if (!overlay.classList.contains('active')) return;
                
                if (e.key >= '0' && e.key <= '9' && pinEntry.length < 6) {
                    pinEntry += e.key;
                    updatePinDisplay();
                    
                    if (pinEntry.length === 6) {
                        setTimeout(() => {
                            submitPin();
                        }, 300);
                    }
                } else if (e.key === 'Backspace' || e.key === 'Delete') {
                    clearPin();
                } else if (e.key === 'Escape') {
                    closePinPad();
                    clearPin();
                }
            });
        }

        function showPinPad(callback) {
            window.pinCallback = callback;
            const overlay = document.getElementById('pin-overlay');
            overlay.classList.add('active');
            pinEntry = '';
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach(dot => {
                dot.classList.remove('filled', 'error');
            });
        }

        function closePinPad() {
            const overlay = document.getElementById('pin-overlay');
            overlay.classList.remove('active');
            window.pinCallback = null;
        }

        async function verifyPin(enteredPin) {
            if (!currentBlob || !currentBlob.pinHash) {
                document.getElementById('pinErrorMessage').textContent = 'No PIN set';
                return;
            }

            const enteredHash = await sha256Hash(enteredPin + currentKey);
            
            if (enteredHash === currentBlob.pinHash) {
                pinUnlocked = true;
                currentPIN = enteredPin;
                grantOwnerAccess(enteredPin);
                closePinPad();

                if (window.pinCallback) {
                    window.pinCallback(true, enteredPin);
                }

                // Refresh the display
                displayEmergencyInfo(currentBlob);
            } else {
                pinAttempts++;
                const dots = document.querySelectorAll('.pin-dot');
                dots.forEach(dot => dot.classList.add('error'));
                
                if (pinAttempts >= maxPinAttempts) {
                    document.getElementById('pinErrorMessage').textContent = 'Too many attempts. Please wait 30 seconds.';
                    setTimeout(() => {
                        pinAttempts = 0;
                        closePinPad();
                    }, 30000);
                } else {
                    document.getElementById('pinErrorMessage').textContent = `Incorrect PIN. ${maxPinAttempts - pinAttempts} attempts remaining.`;
                    setTimeout(() => {
                        pinEntry = '';
                        dots.forEach(dot => dot.classList.remove('filled', 'error'));
                    }, 500);
                }
            }
        }

        // ============= INITIALIZATION =============
        window.addEventListener('DOMContentLoaded', async function() {
            initPinPad();
            await parseAndDisplay();
        });

        async function parseAndDisplay() {
            const hash = window.location.hash.substring(1);

            if (!hash) {
                currentMode = 'create';
                // Default to showing client creator tab
                return;
            }

            // Handle v2 format
            if (hash.startsWith('v2:')) {
                const [version, guid, key, embeddedStr] = hash.split(':');
                currentGUID = guid;
                currentKey = key;
                
                try {
                    const embedded = JSON.parse(atob(embeddedStr));
                    
                    // Try multiple sources to load the data
                    let fullData = null;
                    
                    // 1. Try mock storage first (for testing)
                    if (CONFIG.USE_MOCK_ARCHIVE && mockArchiveStorage.has(guid)) {
                        const data = mockArchiveStorage.get(guid);
                        const decrypted = await decrypt(data.data, key);
                        fullData = JSON.parse(decrypted);
                        console.log('Loaded from mock storage');
                    }
                    
                    // 2. Try local storage
                    if (!fullData) {
                        const localData = localStorage.getItem(`ikey_${guid}`);
                        if (localData) {
                            const parsed = JSON.parse(localData);
                            const decrypted = await decrypt(parsed.data, key);
                            fullData = JSON.parse(decrypted);
                            console.log('Loaded from local storage');
                        }
                    }
                    
                    // 3. Try fetching from Archive.org
                    if (!fullData && !CONFIG.USE_MOCK_ARCHIVE) {
                        try {
                            const archiveUrl = `${CONFIG.ARCHIVE_BASE}${guid}.json`;
                            const response = await fetch(archiveUrl);
                            if (response.ok) {
                                const data = await response.json();
                                const decrypted = await decrypt(data.data, key);
                                fullData = JSON.parse(decrypted);
                                console.log('Loaded from Archive.org');
                            }
                        } catch (e) {
                            console.log('Could not fetch from Archive.org:', e);
                        }
                    }
                    
                    // Use full data if available, otherwise fall back to embedded
                    if (fullData) {
                        currentBlob = fullData;
                    } else {
                        // Create basic blob from embedded data
                        currentBlob = {
                            name: embedded.n,
                            publicInfo: {
                                bloodType: embedded.b,
                                allergies: embedded.a
                            },
                            pinProtected: embedded.p || false
                        };
                        console.log('Using embedded data only');
                    }
                    
                    showQRTab();
                    displayEmergencyInfo(currentBlob);
                } catch (e) {
                    console.error('Failed to parse data:', e);
                    showCreationForm();
                }
            }
        }

        // ============= DISPLAY FUNCTIONS =============
        function displayEmergencyInfo(fullData, options = {}) {
            const container = document.getElementById('main-content');
            const publicInfo = fullData.publicInfo || {};
            const name = fullData.name || 'Unknown';

            let html = `
                <div class="info-card">
                    <div class="info-header">
                        <h2><span class="info-icon">🔑</span> Personal Information</h2>
                    </div>
                    <div class="content">`;

            // Always visible emergency info
            html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">👤</span>
                                <div class="info-content">
                                    <div class="info-label">Name</div>
                                    <div class="info-value">${name}</div>
                                </div>
                            </div>`;

            if (publicInfo.bloodType) {
                html += `
                    <div class="info-item">
                        <span class="info-icon">🩸</span>
                        <div class="info-content">
                            <div class="info-label">Blood Type</div>
                            <div class="info-value">${publicInfo.bloodType}</div>
                        </div>
                    </div>`;
            }

            if (publicInfo.allergies) {
                html += `
                    <div class="info-item">
                        <span class="info-icon">⚠️</span>
                        <div class="info-content">
                            <div class="info-label">Allergies</div>
                            <div class="info-value">${publicInfo.allergies}</div>
                        </div>
                    </div>`;
            }

            html += `</div>`; // Close basic section

            // PIN-protected sections
            const hasPrivateInfo = publicInfo.medications || publicInfo.contact;
            if (hasPrivateInfo && !pinUnlocked) {
                html += `
                    <div class="private-section">
                        <h3>🔒 Additional Information</h3>
                        <p>This section contains medications and emergency contact details.</p>
                        <button class="btn btn-outline" onclick="requestPinUnlock()">
                            Enter PIN to View
                        </button>
                    </div>`;
            } else if (hasPrivateInfo && pinUnlocked) {
                // Show PIN-protected content
                if (publicInfo.medications) {
                    html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">💊</span>
                                <div class="info-content">
                                    <div class="info-label">Medications</div>
                                    <div class="info-value">${publicInfo.medications}</div>
                                </div>
                            </div>
                        </div>`;
                }

                if (publicInfo.contact) {
                    html += `
                        <div class="info-section">
                            <div class="info-item">
                                <span class="info-icon">📞</span>
                                <div class="info-content">
                                    <div class="info-label">Emergency Contact</div>
                                    <div class="info-value">
                                        ${publicInfo.contact.name}
                                        <a href="tel:${publicInfo.contact.phone}" class="phone-link">
                                            📱 ${publicInfo.contact.phone}
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
            }

            // Password-protected health records
            if (fullData.hasEHR && !passwordUnlocked) {
                html += `
                    <div class="private-section">
                        <h3>🏥 Electronic Health Records</h3>
                        <p>This section contains detailed medical history and records.</p>
                        <button class="btn btn-outline" onclick="requestPasswordUnlock()">
                            Enter Password to Access
                        </button>
                    </div>`;
            }

            html += `
                        <div class="help-link">
                            <a href="#" onclick="toggleHelp(); return false;">How It Works</a>
                            <div id="help-content" class="help-content"></div>
                        </div>
                    </div>
                </div>`;

            container.innerHTML = html;
        }

        function requestPinUnlock() {
            showPinPad((success, pin) => {
                if (success) {
                    pinUnlocked = true;
                    displayEmergencyInfo(currentBlob);
                }
            });
        }

        function requestPasswordUnlock() {
            const password = prompt('Enter password to access health records:');
            if (password) {
                // Verify password (implement actual verification)
                if (verifyPassword(password)) {
                    passwordUnlocked = true;
                    showHealthRecordsTab();
                } else {
                    alert('Incorrect password');
                }
            }
        }

        async function verifyPassword(password) {
            if (!currentBlob || !currentBlob.passwordHash) return false;
            const hash = await sha256Hash(password + currentKey);
            return hash === currentBlob.passwordHash;
        }

        function showCreationForm() {
            currentMode = 'create';
            const container = document.getElementById('main-content');

            container.innerHTML = `
                <div class="header">
                    <h1>Create Your iKey</h1>
                    <p>Your data. Your key. Your control.</p>
                </div>
                <div class="content">
                    <form id="create-form" autocomplete="off">
                        <fieldset class="section-fieldset">
                            <legend class="section-title">
                                Personal Information 
                                <span class="section-status incomplete" id="personal-status">Incomplete</span>
                            </legend>

                            <div class="form-group">
                                <label for="name">Name *</label>
                                <input type="text" id="name" name="name" required placeholder="John Doe">
                            </div>

                            <div class="form-group">
                                <label>Blood Type (Optional)</label>
                                <div class="blood-type-grid" role="radiogroup" aria-label="Blood Type">
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="A+">
                                        <span>A+</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="B+">
                                        <span>B+</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="AB+">
                                        <span>AB+</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="O+">
                                        <span>O+</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="A-">
                                        <span>A-</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="B-">
                                        <span>B-</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="AB-">
                                        <span>AB-</span>
                                    </label>
                                    <label class="blood-type-btn">
                                        <input type="radio" name="blood-type" value="O-">
                                        <span>O-</span>
                                    </label>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="allergies">Allergies</label>
                                <textarea id="allergies" name="allergies" placeholder="Penicillin, peanuts, etc."></textarea>
                            </div>

                            <div class="form-group">
                                <label for="medications">Medications</label>
                                <textarea id="medications" name="medications" placeholder="Current medications"></textarea>
                            </div>

                            <div class="form-group">
                                <label for="contact-name">Emergency Contact Name *</label>
                                <input type="text" id="contact-name" name="contact-name" required placeholder="Jane Doe">
                            </div>

                            <div class="form-group">
                                <label for="contact-phone">Emergency Contact Phone *</label>
                                <input type="tel" id="contact-phone" name="contact-phone" required placeholder="(555) 123-4567">
                            </div>
                        </fieldset>

                        <fieldset class="section-fieldset">
                            <legend class="section-title">
                                Security PIN
                                <span class="section-status incomplete" id="pin-status">Incomplete</span>
                            </legend>

                            <div class="form-group">
                                <label for="pin">6-Digit Security PIN *</label>
                                <input type="password" id="pin" name="pin" required placeholder="Enter 6 digits" 
                                       pattern="[0-9]{6}" maxlength="6" inputmode="numeric" autocomplete="new-password">
                                <div class="hint">This PIN will protect your emergency information</div>
                            </div>

                            <div class="form-group">
                                <label for="pin-confirm">Confirm PIN *</label>
                                <input type="password" id="pin-confirm" name="pin-confirm" required placeholder="Re-enter PIN" 
                                       pattern="[0-9]{6}" maxlength="6" inputmode="numeric" autocomplete="new-password">
                            </div>
                        </fieldset>

                        <fieldset class="section-fieldset">
                            <legend class="section-title">
                                Advanced Security (Optional)
                                <span class="section-status" id="password-status">Optional</span>
                            </legend>

                            <div class="form-group">
                                <label for="password">Password (for Health Records)</label>
                                <input type="password" id="password" name="password" placeholder="Optional - for EHR access" autocomplete="new-password">
                                <div id="password-strength" class="hint"></div>
                            </div>

                            <div class="form-group">
                                <label for="password-confirm">Confirm Password</label>
                                <input type="password" id="password-confirm" name="password-confirm" placeholder="Re-enter password" autocomplete="new-password">
                            </div>

                            <div class="hint">
                                The PIN provides quick access to emergency info. The optional password adds extra protection for health records and private data.
                            </div>
                        </fieldset>

                        <button type="submit" class="btn">
                            <span>Create iKey</span>
                        </button>
                    </form>

                    <div id="qr-result" style="display: none;">
                        <div class="qr-display">
                            <h3>✅ Your iKey Created</h3>
                            <p style="color: #666; font-size: 0.875rem; margin: 10px 0;">
                                ✓ Encrypted with zero-knowledge security<br>
                                ✓ Only this QR can decrypt your data
                            </p>
                            <div id="qrcode"></div>
                            <div class="action-buttons">
                                <button class="btn" onclick="downloadQR()">💾 Download</button>
                                <button class="btn" onclick="testQR()">🔍 Test</button>
                            </div>
                        </div>
                    </div>

                    <div id="status-message"></div>
                </div>`;

            // Add event handlers
            document.getElementById('create-form').addEventListener('submit', handleCreateForm);
            
            // Blood type selector
            document.querySelectorAll('.blood-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.blood-type-btn').forEach(b => 
                        b.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Password strength
            document.getElementById('password').addEventListener('input', function() {
                const pwd = this.value;
                const strength = getPasswordStrength(pwd);
                document.getElementById('password-strength').textContent = `Strength: ${strength}`;
            });

            // Section status updates
            updateSectionStatus();
            ['name', 'contact-name', 'contact-phone'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSectionStatus);
            });
            ['pin', 'pin-confirm'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSectionStatus);
            });
            ['password', 'password-confirm'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSectionStatus);
            });
        }

        async function handleCreateForm(e) {
            e.preventDefault();

            const button = e.target.querySelector('button[type="submit"]');
            button.disabled = true;
            button.innerHTML = '<span>Creating...</span>';

            try {
                const pin = document.getElementById('pin').value;
                const confirmPin = document.getElementById('pin-confirm').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('password-confirm').value;

                // Validate PIN
                if (!/^\d{6}$/.test(pin)) {
                    throw new Error('PIN must be exactly 6 digits');
                }

                if (pin !== confirmPin) {
                    throw new Error('PINs do not match');
                }

                // Validate password if provided
                if (password) {
                    if (password !== confirmPassword) {
                        throw new Error('Passwords do not match');
                    }
                    if (password.length < 8) {
                        throw new Error('Password must be at least 8 characters');
                    }
                }

                // Generate identifiers
                currentGUID = generateGUID();
                currentKey = generateKey();

                // Collect form data
                const formData = {
                    name: document.getElementById('name').value,
                    bloodType: document.querySelector('input[name="blood-type"]:checked')?.value || '',
                    allergies: document.getElementById('allergies').value,
                    medications: document.getElementById('medications').value,
                    contactName: document.getElementById('contact-name').value,
                    contactPhone: document.getElementById('contact-phone').value
                };

                // Create encrypted payload
                const publicInfo = {
                    bloodType: formData.bloodType,
                    allergies: formData.allergies,
                    medications: formData.medications,
                    contact: {
                        name: formData.contactName,
                        phone: formData.contactPhone
                    }
                };

                // Hash the PIN and password
                const pinHash = await sha256Hash(pin + currentKey);
                const passwordHash = password ? await sha256Hash(password + currentKey) : null;

                currentBlob = {
                    name: formData.name,
                    publicInfo,
                    pinProtected: true,
                    pinHash,
                    passwordHash,
                    hasEHR: !!password,
                    created: new Date().toISOString()
                };

                // Encrypt data
                const encryptedData = await encrypt(JSON.stringify(currentBlob), currentKey);

                // Prepare archive payload
                const archivePayload = {
                    encrypted: true,
                    version: "3.0",
                    guid: currentGUID,
                    data: encryptedData,
                    metadata: {
                        created: new Date().toISOString(),
                        hasPIN: true,
                        hasPassword: !!password
                    }
                };

                // Send to webhook
                showStatus('Uploading encrypted data...', 'info');
                
                try {
                    const response = await fetch(CONFIG.WEBHOOK_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-archive-meta-subject': 'Emergency Contacts',
                            'x-archive-meta-description': 'Encrypted emergency contact information',
                            'x-archive-meta-guid': currentGUID,
                            'x-archive-meta-identifier': `ikey_${currentGUID}`,
                            'x-archive-meta-mediatype': 'data'
                        },
                        body: JSON.stringify(archivePayload)
                    });

                    if (!response.ok) {
                        console.warn('Webhook returned status:', response.status);
                        // Continue anyway - the QR still works locally
                    } else {
                        console.log('Successfully uploaded to webhook');
                    }
                } catch (uploadError) {
                    console.error('Upload error:', uploadError);
                    // Don't fail the whole process if upload fails
                    showStatus('Warning: Cloud backup failed, but QR code works offline', 'warning');
                }

                // Also store in mock storage for testing
                if (CONFIG.USE_MOCK_ARCHIVE) {
                    mockArchiveStorage.set(currentGUID, archivePayload);
                    console.log('Stored in mock archive:', currentGUID);
                }

                // Store locally as fallback
                try {
                    localStorage.setItem(`ikey_${currentGUID}`, JSON.stringify(archivePayload));
                } catch (e) {
                    console.log('Could not store locally:', e);
                }

                // Generate embedded data
                const embedded = btoa(JSON.stringify({
                    n: formData.name,
                    b: formData.bloodType,
                    a: formData.allergies,
                    p: true, // Has PIN protection
                    t: new Date().toISOString()
                }));

                // Create QR URL
                const qrUrl = `${CONFIG.VIEWER_URL}#v2:${currentGUID}:${currentKey}:${embedded}`;
                window.currentQRUrl = qrUrl;

                // Generate QR code
                const qrContainer = document.getElementById('qrcode');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: qrUrl,
                    width: 256,
                    height: 256,
                    correctLevel: QRCode.CorrectLevel.M
                });

                // Show success
                document.getElementById('create-form').style.display = 'none';
                document.getElementById('qr-result').style.display = 'block';
                showStatus('iKey created successfully! PIN: ' + pin, 'success');

            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>Create iKey</span>';
            }
        }

        // ============= UTILITY FUNCTIONS =============
        async function sha256Hash(text) {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }
        function generateGUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateKey(length = 32) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return btoa(String.fromCharCode.apply(null, array))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function encrypt(text, password) {
            const enc = new TextEncoder();
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));

            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );

            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["encrypt"]
            );

            const encrypted = await crypto.subtle.encrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                enc.encode(text)
            );

            const encryptedContent = new Uint8Array(encrypted);
            const buf = new Uint8Array(salt.byteLength + iv.byteLength + encryptedContent.byteLength);
            buf.set(salt, 0);
            buf.set(iv, salt.byteLength);
            buf.set(encryptedContent, salt.byteLength + iv.byteLength);

            return btoa(String.fromCharCode(...buf));
        }

        async function decrypt(encryptedData, password) {
            const enc = new TextEncoder();
            const dec = new TextDecoder();

            const data = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
            const salt = data.slice(0, 16);
            const iv = data.slice(16, 28);
            const encrypted = data.slice(28);

            const passwordKey = await crypto.subtle.importKey(
                "raw",
                enc.encode(password),
                "PBKDF2",
                false,
                ["deriveBits", "deriveKey"]
            );

            const aesKey = await crypto.subtle.deriveKey(
                {
                    name: "PBKDF2",
                    salt: salt,
                    iterations: 100000,
                    hash: "SHA-256"
                },
                passwordKey,
                { 
                    name: "AES-GCM",
                    length: 256
                },
                false,
                ["decrypt"]
            );

            const decrypted = await crypto.subtle.decrypt(
                { 
                    name: "AES-GCM",
                    iv: iv,
                    tagLength: 128
                },
                aesKey,
                encrypted
            );

            return dec.decode(decrypted);
        }

        function getPasswordStrength(pwd) {
            if (!pwd) return '';
            let score = 0;
            if (pwd.length >= 8) score++;
            if (/[a-z]/.test(pwd)) score++;
            if (/[A-Z]/.test(pwd)) score++;
            if (/\d/.test(pwd)) score++;
            if (/[^A-Za-z0-9]/.test(pwd)) score++;
            if (pwd.length >= 12) score++;
            
            if (score >= 5) return 'Strong';
            if (score >= 3) return 'Medium';
            return 'Weak';
        }

        function updateSectionStatus() {
            const personalStatus = document.getElementById('personal-status');
            const pinStatus = document.getElementById('pin-status');
            const passwordStatus = document.getElementById('password-status');

            if (personalStatus) {
                const name = document.getElementById('name')?.value.trim();
                const cName = document.getElementById('contact-name')?.value.trim();
                const cPhone = document.getElementById('contact-phone')?.value.trim();
                
                if (name && cName && cPhone) {
                    personalStatus.textContent = 'Complete';
                    personalStatus.classList.add('complete');
                    personalStatus.classList.remove('incomplete');
                } else {
                    personalStatus.textContent = 'Incomplete';
                    personalStatus.classList.add('incomplete');
                    personalStatus.classList.remove('complete');
                }
            }

            if (pinStatus) {
                const pin = document.getElementById('pin')?.value;
                const pin2 = document.getElementById('pin-confirm')?.value;
                
                if (pin && pin === pin2 && /^\d{6}$/.test(pin)) {
                    pinStatus.textContent = 'Complete';
                    pinStatus.classList.add('complete');
                    pinStatus.classList.remove('incomplete');
                } else {
                    pinStatus.textContent = 'Incomplete';
                    pinStatus.classList.add('incomplete');
                    pinStatus.classList.remove('complete');
                }
            }

            if (passwordStatus) {
                const pwd = document.getElementById('password')?.value;
                const pwd2 = document.getElementById('password-confirm')?.value;
                
                if (pwd && pwd === pwd2 && pwd.length >= 8) {
                    passwordStatus.textContent = 'Set';
                    passwordStatus.classList.add('complete');
                    passwordStatus.classList.remove('incomplete');
                } else {
                    passwordStatus.textContent = 'Optional';
                    passwordStatus.classList.remove('complete');
                    passwordStatus.classList.remove('incomplete');
                }
            }
        }

        function showStatus(message, type) {
            const element = document.getElementById('status-message');
            if (!element) return;

            element.className = 'status-message status-' + type;
            element.textContent = message;
            element.style.display = 'block';

            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) return;

            const link = document.createElement('a');
            link.download = `ikey-${currentGUID || 'emergency'}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function testQR() {
            if (window.currentQRUrl) {
                window.open(window.currentQRUrl, '_blank');
            }
        }

        function toggleHelp() {
            const helpContent = document.getElementById('help-content');
            if (!helpContent) return;

            if (helpContent.classList.contains('active')) {
                helpContent.classList.remove('active');
            } else {
                helpContent.innerHTML = `
                    <h4>How iKey Works</h4>
                    <p>Your information is encrypted before leaving your device:</p>
                    <ul>
                        <li>✓ Public info helps in emergencies</li>
                        <li>✓ Private info needs your password</li>
                        <li>🔑 Your QR code is the only way to decrypt</li>
                    </ul>
                    <p><strong>True Security:</strong><br>
                    Not even iKey can access your data. The QR code contains<br>
                    the only decryption key that exists. Lose it = lose access forever.</p>`;
                helpContent.classList.add('active');
            }
        }

        // ============= NAVIGATION =============
        function showClientCreator() {
            document.getElementById('clientCreatorTab').style.display = 'block';
            document.getElementById('qrTab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'none';
        }

        function showQRTab() {
            document.getElementById('clientCreatorTab').style.display = 'none';
            document.getElementById('qrTab').style.display = 'block';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'none';
        }

        function showHealthRecordsTab() {
            document.getElementById('clientCreatorTab').style.display = 'none';
            document.getElementById('qrTab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'block';
            document.getElementById('text911Tab').style.display = 'none';
        }

        function show911Tab() {
            document.getElementById('clientCreatorTab').style.display = 'none';
            document.getElementById('qrTab').style.display = 'none';
            document.getElementById('healthRecordsTab').style.display = 'none';
            document.getElementById('text911Tab').style.display = 'block';
        }

        function confirmEmergencyAccess() {
            if (confirm('Open Emergency Services?')) {
                show911Tab();
            }
        }

        async function requestLocationAndLoad911() {
            try {
                await navigator.geolocation.getCurrentPosition(
                    (position) => {
                        document.getElementById('location-permission-prompt').style.display = 'none';
                        document.getElementById('location-content').style.display = 'block';
                        console.log('Location enabled:', position.coords);
                    },
                    (error) => {
                        alert('Location access is required for 911 emergency features.');
                    },
                    { enableHighAccuracy: true }
                );
            } catch (error) {
                alert('Unable to access location.');
            }
        }

        // ============= OWNER FUNCTIONS =============
        function grantOwnerAccess(password) {
            ownerPassword = password;
            document.querySelector('.login-btn').style.display = 'none';
            document.querySelector('.dashboard-btn').style.display = 'inline-block';
            document.querySelector('.logout-btn').style.display = 'inline-block';
            document.querySelector('.health-records-btn').style.display = 'inline-block';
        }

        async function ownerLogin() {
            const password = prompt('Enter owner password:');
            if (password === 'demo123') {  // For testing
                grantOwnerAccess(password);
                showOwnerDashboard();
            } else {
                alert('Invalid password');
            }
        }

        function logoutOwner() {
            ownerPassword = null;
            document.querySelector('.dashboard-btn').style.display = 'none';
            document.querySelector('.health-records-btn').style.display = 'none';
            document.querySelector('.logout-btn').style.display = 'none';
            document.querySelector('.login-btn').style.display = 'inline-block';
            showQRTab();
        }

        function showOwnerDashboard() {
            showQRTab();
            const container = document.getElementById('main-content');
            
            if (!currentBlob) {
                container.innerHTML = `
                    <div class="dashboard-container">
                        <h2>Owner Dashboard</h2>
                        <p>No iKey loaded. Create one to see the dashboard.</p>
                        <button class="btn" onclick="showCreationForm()">Create iKey</button>
                    </div>`;
                return;
            }

            const completionPercent = 60; // Example percentage

            container.innerHTML = `
                <div class="dashboard-container">
                    <div class="dashboard-header">
                        <div class="progress-ring">
                            <svg width="120" height="120">
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                                <circle cx="60" cy="60" r="54" fill="none" stroke="#667eea" stroke-width="8"
                                        stroke-dasharray="${339 * completionPercent / 100} 339"
                                        transform="rotate(-90 60 60)"/>
                            </svg>
                            <div class="progress-text">
                                <div class="percent">${completionPercent}%</div>
                                <div class="label">Complete</div>
                            </div>
                        </div>
                        <div class="profile-summary">
                            <h2>${currentBlob.name || 'Your iKey'}</h2>
                            <p class="security-status">Security Level: <span class="level-good">Good</span></p>
                        </div>
                    </div>

                    <div class="section-cards">
                        <div class="section-card">
                            <div class="section-header">
                                <span class="section-icon">👤</span>
                                <h3>Basic Info</h3>
                            </div>
                            <div class="field-row">
                                <span>Name</span>
                                <span>${currentBlob.name || '—'}</span>
                            </div>
                        </div>

                        <div class="section-card">
                            <div class="section-header">
                                <span class="section-icon">🚨</span>
                                <h3>Emergency</h3>
                            </div>
                            <div class="field-row">
                                <span>Blood Type</span>
                                <span>${currentBlob.publicInfo?.bloodType || '—'}</span>
                            </div>
                            <div class="field-row">
                                <span>Allergies</span>
                                <span>${currentBlob.publicInfo?.allergies || '—'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button onclick="downloadQR()" class="action-btn">Download QR</button>
                        <button onclick="testQR()" class="action-btn">Test QR</button>
                    </div>
                </div>`;
        }

        // ============= DEV TOOLS =============
        function toggleDevTools() {
            const panel = document.getElementById('dev-panel');
            panel.classList.toggle('active');
        }

        async function devLoadQR() {
            const guid = document.getElementById('dev-guid').value;
            const key = document.getElementById('dev-key').value;

            if (!guid || !key) {
                document.getElementById('dev-output').textContent = 'Please enter both GUID and Key';
                return;
            }

            currentGUID = guid;
            currentKey = key;

            // Try to load from mock storage
            if (CONFIG.USE_MOCK_ARCHIVE && mockArchiveStorage.has(guid)) {
                const data = mockArchiveStorage.get(guid);
                try {
                    const decrypted = await decrypt(data.data, key);
                    currentBlob = JSON.parse(decrypted);
                    showQRTab();
                    displayEmergencyInfo(currentBlob);
                    document.getElementById('dev-output').textContent = 'Successfully loaded QR data';
                } catch (e) {
                    document.getElementById('dev-output').textContent = 'Failed to decrypt: ' + e.message;
                }
            } else {
                document.getElementById('dev-output').textContent = 'No data found for this GUID';
            }
        }

        async function devTestArchive() {
            const guid = document.getElementById('dev-guid').value;
            if (!guid) {
                document.getElementById('dev-output').textContent = 'Please enter a GUID';
                return;
            }

            if (CONFIG.USE_MOCK_ARCHIVE) {
                if (mockArchiveStorage.has(guid)) {
                    const data = mockArchiveStorage.get(guid);
                    document.getElementById('dev-output').textContent = 
                        `Found in mock storage:\n${JSON.stringify(data, null, 2)}`;
                } else {
                    document.getElementById('dev-output').textContent = 'Not found in mock storage';
                }
            }
        }

        async function devCreateTestQR() {
            // Generate test data
            currentGUID = generateGUID();
            currentKey = generateKey();

            const testData = {
                name: "Test User",
                publicInfo: {
                    bloodType: "O+",
                    allergies: "Penicillin, Peanuts",
                    medications: "Aspirin 81mg daily",
                    contact: {
                        name: "Jane Doe",
                        phone: "(555) 123-4567"
                    }
                },
                created: new Date().toISOString()
            };

            currentBlob = testData;

            // Encrypt and store
            const encryptedData = await encrypt(JSON.stringify(testData), currentKey);
            
            if (CONFIG.USE_MOCK_ARCHIVE) {
                mockArchiveStorage.set(currentGUID, {
                    encrypted: true,
                    version: "3.0",
                    data: encryptedData
                });
            }

            // Generate embedded data
            const embedded = btoa(JSON.stringify({
                n: testData.name,
                b: testData.publicInfo.bloodType,
                a: testData.publicInfo.allergies,
                t: testData.created
            }));

            // Create URL
            const qrUrl = `${CONFIG.VIEWER_URL}#v2:${currentGUID}:${currentKey}:${embedded}`;
            
            document.getElementById('dev-output').textContent = 
                `Test QR Created:\nGUID: ${currentGUID}\nKey: ${currentKey}\nURL: ${qrUrl}`;

            // Update location hash
            window.location.hash = `v2:${currentGUID}:${currentKey}:${embedded}`;
            
            // Display the test data
            showQRTab();
            displayEmergencyInfo(testData);
        }

        function devShowRawData() {
            const output = {
                currentGUID,
                currentKey,
                currentMode,
                currentBlob,
                mockStorageSize: mockArchiveStorage.size
            };
            
            document.getElementById('dev-output').textContent = 
                JSON.stringify(output, null, 2);
        }

        function devClearStorage() {
            currentGUID = null;
            currentKey = null;
            currentData = null;
            currentBlob = null;
            mockArchiveStorage.clear();
            window.location.hash = '';
            document.getElementById('dev-output').textContent = 'All data cleared';
        }

        // ============= LANGUAGE FUNCTIONS =============
        function toggleLangDropdown() {
            const dropdown = document.querySelector('.lang-dropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
            }
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('current-language').textContent = lang.toUpperCase();
            // Apply translations
            const t = translations[lang] || translations.en;
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });
        }

        // ============= TEXT SIZE FUNCTIONS =============
        function changeTextSize(delta) {
            const sizes = ['16px', '18px', '20px', '22px', '24px'];
            const currentSize = getComputedStyle(document.documentElement).fontSize;
            const currentIndex = sizes.indexOf(currentSize);
            const newIndex = Math.min(Math.max(currentIndex + delta, 0), sizes.length - 1);
            document.documentElement.style.fontSize = sizes[newIndex];
        }

        // Triple-click to show dev tools
        let clickCount = 0;
        let clickTimer = null;

        document.addEventListener('click', function(e) {
            if (e.target.closest('.dev-trigger') || e.target.closest('.dev-panel')) return;

            clickCount++;

            if (clickCount === 3) {
                document.querySelector('.dev-trigger').style.opacity = '1';
                clickCount = 0;
            }

            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => {
                clickCount = 0;
            }, 500);
        });
    </script>
</body>
</html>
